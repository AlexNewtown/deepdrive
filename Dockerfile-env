# Requires NVIDIA drivers 390+
#
# Build (automated on dockerhub, so just use for local testing, don't push):
#
# VERSION=`cat VERSION | sed 's/ //g'`
# docker build --build-arg version=$VERSION -t deepdriveio/deepdrive:env-$VERSION -f Dockerfile-env .
#
# Usage:
# VERSION=`cat VERSION | sed 's/ //g'`
# docker run -it --net=host --runtime=nvidia deepdriveio/deepdrive:env-$VERSION

FROM nvidia/opengl:1.0-glvnd-runtime-ubuntu16.04

ARG version=3.0

RUN apt-get update;

# OS dependencies
RUN apt-get update; apt-get install -y libsdl2-2.0 software-properties-common python-software-properties sudo \
        python3-pip python3-dev \
      && cd /usr/local/bin \
      && ln -s /usr/bin/python3 python \
      && pip3 install --upgrade pip

# Python dependencies
RUN pip install "deepdrive > $version.*dev0"
COPY docker/env-requirements.txt .
RUN pip install --no-cache-dir -r env-requirements.txt

# Cleanup
RUN apt-get clean && rm -rf /var/lib/apt/lists/*

# Non-root user for Unreal
RUN useradd -m a
USER a
ENV HOME /home/a
USER root
RUN chown -R a:a /home/a
RUN apt-get -y install sudo
RUN echo "a:a" | chpasswd && adduser a sudo
USER a
WORKDIR /home/a/src/deepdrive

# Download sim
ENV PYTHONPATH=/home/a/src/deepdrive
ENV DEEPDRIVE_DIR=/home/a/Deepdrive
COPY config/ ./config/
COPY VERSION logs.py utils.py ./

RUN python -c "import utils; utils.ensure_sim();"


# LibSDL2 offscreen opengl mode
ENV SDL_VIDEODRIVER=offscreen

# API
EXPOSE 5557/tcp

COPY . .

CMD python api/server.py
