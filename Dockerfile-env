# Requires NVIDIA drivers 390+
#
# Build (automated on dockerhub, so just use for local testing, don't push):
#
# VERSION=`cat VERSION | sed 's/ //g'`
# docker build --build-arg version=$VERSION -t deepdriveio/deepdrive:env-$VERSION -f Dockerfile-env .
#
# Usage:
# VERSION=`cat VERSION | sed 's/ //g'`
# docker run -it --net=host --runtime=nvidia deepdriveio/deepdrive:env-$VERSION

FROM adamrehn/ue4-runtime:tensorflow-virtualgl

ARG version=3.0


USER root
RUN apt-get update

# OS dependencies
# RUN apt-get update; apt-get install -y libsdl2-2.0 software-properties-common software-properties-common sudo \
#         python3-pip python3-dev \
#       && cd /usr/local/bin \
#       && ln -s /usr/bin/python3 python \
#       && pip3 install --upgrade pip

# Non-root user for Unreal
ARG user=dd
RUN useradd -m $user
USER $user
ENV HOME /home/$user
USER root
RUN chown -R $user:$user /home/$user
RUN echo "$user:$user" | chpasswd && adduser $user sudo
WORKDIR /home/$user/src/deepdrive

# Cleanup
RUN sudo apt-get clean && rm -rf /var/lib/apt/lists/*

# Install deepdrive
# USER $user
ENV PYTHONPATH=/home/$user/src/deepdrive
ENV DEEPDRIVE_DIR=/home/$user/Deepdrive
COPY config/ ./config/
COPY VERSION logs.py utils.py install.py requirements.txt ./
RUN python install.py

RUN python -c "import utils; utils.ensure_sim();"


# LibSDL2 offscreen opengl mode
ENV SDL_VIDEODRIVER=offscreen

# API
EXPOSE 5557/tcp

COPY . .

CMD python api/server.py
